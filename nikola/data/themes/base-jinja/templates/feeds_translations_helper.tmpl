{#  -*- coding: utf-8 -*- #}

{% macro _append_language(language) %}{{  " (" + language + ")" if translations|length > 1 else ""  }}{% endmacro %}
{% macro _append_name(name, kind) %}{{  (" (" + name + ")" if name and kind != "archive" and kind != "author" else "") | h  }}{% endmacro %}
{% macro _append_name_language_proper(language, kind, name) %}{{  (" (" + name + ", " + language + ")" if name and kind != "archive" and kind != "author" else " (" + language + ")") | h  }}{% endmacro %}
{% macro _append_name_language(language, kind, name=None) %}{{  _append_name_language_proper(language, kind, name) if translations|length > 1 else _append_name(name, kind)  }}{% endmacro %}

{% macro _head_rss(classification=None, kind='index', rss_override=True) %}
    {% if rss_link and rss_override %}
        {{ rss_link }}
    {% endif %}
    {% if generate_rss and not (rss_link and rss_override) and kind != 'archive' %}
        {% if translations|length > 1 and has_other_languages and classification and kind != 'index' %}
            {% for language, classification, name in all_languages %}
                <link rel="alternate" type="application/rss+xml" title="RSS for {{ kind }} {{ name|e }} ({{ language }})" hreflang="{{ language }}" href="{{ _link(kind + "_rss", classification, language) }}">
            {% endfor %}
        {% else %}
            {% for language in translations|sort %}
                {% if classification and kind != 'index' %}
                    <link rel="alternate" type="application/rss+xml" title="RSS for {{ kind }} {{ classification|e }}{{ _append_language(language) }}" hreflang="{{ language }}" href="{{ _link(kind + "_rss", classification, language) }}">
                {% else %}
                    <link rel="alternate" type="application/rss+xml" title="RSS{{ _append_language(language) }}" hreflang="{{ language }}" href="{{ _link("index_rss", None, language) }}">
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro _head_atom(classification=None, kind='index') %}
    {% if generate_atom %}
        {% if translations|length > 1 and has_other_languages and classification and kind != 'index' %}
            {% for language, classification, name in all_languages %}
                <link rel="alternate" type="application/atom+xml" title="Atom for {{ kind }} {{ name|e }} ({{ language }})" hreflang="{{ language }}" href="{{ _link(kind + "_atom", classification, language) }}">
            {% endfor %}
        {% else %}
            {% for language in translations|sort %}
                {% if classification and kind != 'index' %}
                    <link rel="alternate" type="application/atom+xml" title="Atom for {{ kind }} {{ classification|e }}{{ _append_language(language) }}" hreflang="{{ language }}" href="{{ _link(kind + "_atom", classification, language) }}">
                {% else %}
                    <link rel="alternate" type="application/atom+xml" title="Atom{{ _append_language(language) }}" hreflang="{{ language }}" href="{{ _link("index_atom", None, language) }}">
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
{% endmacro %}

{#  Handles both feeds and translations #}
{% macro head(classification=None, kind='index', feeds=True, other=True, rss_override=True, has_no_feeds=False) %}
    {% if feeds and not has_no_feeds %}
        {{ _head_rss(classification, 'index' if (kind == 'archive' and rss_override) else kind, rss_override) }}
        {{ _head_atom(classification, kind) }}
    {% endif %}
    {% if other and has_other_languages and other_languages %}
        {% for language, classification, _ in other_languages %}
            <link rel="alternate" hreflang="{{ language }}" href="{{ _link(kind, classification, language) }}">
        {% endfor %}
    {% endif %}
{% endmacro %}

{% macro feed_link(classification, kind) %}
    {% if generate_atom or generate_rss %}
        {% if translations|length > 1 and has_other_languages and kind != 'index' %}
            {% for language, classification, name in all_languages %}
                <p class="feedlink">
                    {% if generate_atom %}
                        <a href="{{ _link(kind + "_atom", classification, language) }}" hreflang="{{ language }}" type="application/atom+xml">{{ messages('Atom feed', language) }} {{ _append_name_language(language, kind, name) }}</a>
                    {% endif %}
                    {% if generate_rss and kind != 'archive' %}
                        <a href="{{ _link(kind + "_rss", classification, language) }}" hreflang="{{ language }}" type="application/rss+xml">{{ messages('RSS feed', language) }} {{ _append_name_language(language, kind, name) }}</a>
                    {% endif %}
                </p>
            {% endfor %}
        {% else %}
            {% for language in translations|sort %}
                <p class="feedlink">
                    {% if generate_atom %}
                        <a href="{{ _link(kind + "_atom", classification, language) }}" hreflang="{{ language }}" type="application/atom+xml">{{ messages('Atom feed', language) }}{{ _append_language(language) }}</a>
                    {% endif %}
                    {% if generate_rss and kind != 'archive' %}
                        <a href="{{ _link(kind + "_rss", classification, language) }}" hreflang="{{ language }}" type="application/rss+xml">{{ messages('RSS feed', language) }}{{ _append_language(language) }}</a>
                    {% endif %}
                </p>
            {% endfor %}
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro translation_link(kind) %}
    {% if has_other_languages and other_languages %}
        <div class="translationslist translations">
            <h3 class="translationslist-intro">{{ messages("Also available in:") }}</h3>
        {% for language, classification, name in other_languages %}
            <p><a href="{{ _link(kind, classification, language) }}" hreflang="{{ language }}" rel="alternate">{{ messages("LANGUAGE", language) }} {{ _append_name(name, kind) }}</a></p>
        {% endfor %}
        </div>
    {% endif %}
{% endmacro %}
